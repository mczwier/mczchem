% Working environment for everything chemistry
% Sets up formatting (by default)
% Also includes a slew of packages: amsmath, amsthm, graphicx, tikz
% hyperref, mhchem, enumitem, tabular
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{mczchem}[2014/07/16 v0.1]

\RequirePackage{kvoptions}

% Options to allow disabling stuff if another driver has to be used
\DeclareBoolOption[true]{usefonts}
\DeclareBoolOption[true]{microtype}
\DeclareBoolOption[true]{fullpage}
\DeclareBoolOption[true]{color}

% General requirements
\RequirePackage{amsmath}
\RequirePackage{amsthm}
\RequirePackage{graphicx}
\RequirePackage{tikz}
\RequirePackage[version=3,arrows=pgf]{mhchem}
\RequirePackage{tabulary}
\RequirePackage{xparse}
\RequirePackage{suffix}
\RequirePackage{etoolbox}
\RequirePackage{relsize}
\RequirePackage{mathtools}
\RequirePackage{chngcntr}

\ProcessKeyvalOptions*


\ifmczchem@color
%\definecolor{DrakeBlue}{HTML}{12367C}
%\definecolor{DrakeCompRed}{HTML}{982700}
\definecolor{DrakeBlue}{HTML}{004477}
%\definecolor{DrakeCompRed}{HTML}{552222}
\definecolor{DrakeCompRed}{HTML}{880033}
\else
% uuuuugly lazy hack
\definecolor{DrakeBlue}{HTML}{000000}
\definecolor{DrakeCompRed}{HTML}{000000}
\fi

\ifmczchem@usefonts
	%\RequirePackage[no-math]{fontspec}
    \RequirePackage{fontspec}
	\defaultfontfeatures{Ligatures=TeX}

	\setmainfont[ItalicFont=Minion Pro Italic,
				 BoldFont=Minion Pro Bold,
				 BoldItalicFont=Minion Pro Bold Italic]{Minion Pro Regular}
	%\setmonofont[Scale=MatchLowercase]{Cousine}
	\setmonofont[Scale=MatchLowercase]{Source Code Pro}
	
	\newfontfamily\rmdemifamily{Minion Pro Semibold}%
	[ItalicFont=Minion Pro Semibold Italic,
     BoldFont=Minion Pro Bold,
     BoldItalicFont=Minion Pro Bold Italic,
     Scale=MatchLowercase]
	 
	\newfontfamily\sfmediumfamily{Optima LT Std Medium}%
	[ItalicFont=Optima LT Std Medium Italic,
	BoldFont=Optima LT Std Black,
	BoldItalicFont=Optima LT Std Black Italic,
    Scale=MatchLowercase]
	
	\newfontfamily\sfdemifamily{Optima LT Std Demi}%
	[ItalicFont=Optima LT Std Demi Italic,
	BoldFont=Optima LT Std Extra Black,
	BoldItalicFont=Optima LT Std Extra Black Italic,
    Scale=MatchLowercase]
	
	\@ifclassloaded{beamer}{
	\setsansfont%
 	[ Scale=MatchLowercase,
	  ItalicFont=Optima LT Std Italic,
   	  BoldFont=Optima LT Std Demi,
   	  BoldItalicFont=Optima LT Std Demi Italic]{Optima LT Std Roman}
	  \newfontface\subtitleface{Optima LT Std Demi}
	  %\usepackage{mathpazo}
	  
	}{\setsansfont%
 	[ Scale=MatchLowercase,
	  ItalicFont=Optima LT Std Italic,
   	  BoldFont=Optima LT Std Bold,
   	  BoldItalicFont=Optima LT Std Bold Italic]{Optima LT Std Roman}
	\newfontface\subtitleface{Optima LT Std Medium}
	}
	
	\usepackage[math-style=ISO,bold-style=ISO,vargreek-shape=unicode]{unicode-math}
    %\setmathfont[Scale=MatchLowercase]{Asana Math}
    \setmathfont[Scale=MatchLowercase]{texgyrepagella-math.otf}
\else
	\newcommand\rmdemifamily\bfseries
	\newcommand\sfmediumfamily{\sffamily\mdseries}
	\newcommand\sfdemifamily{\sffamily\bfseries}
\fi

\newcommand\headfamily\sffamily
	
\ifmczchem@microtype
	\RequirePackage{microtype}
\fi

\@ifclassloaded{beamer}
  {\relax}
  {\RequirePackage{multicol}
   \ifmczchem@fullpage
   	 \RequirePackage{fullpage}
   \fi
   \ifmczchem@usefonts
	\RequirePackage{tocloft}
	\RequirePackage{titlesec}
	\RequirePackage{titling}


	% titlesec
	\titleformat*{\section}{\Large\headfamily\bfseries\color{DrakeBlue}}
	\titleformat*{\subsection}{\large\headfamily\bfseries\color{DrakeBlue}}
	\titleformat*{\subsubsection}{\headfamily\bfseries\color{DrakeBlue}}
	
	% titling
	\renewcommand{\maketitlehooka}{\headfamily\bfseries\color{DrakeBlue}}
	\renewcommand{\maketitlehookb}{\mdseries\subtitleface\color{DrakeBlue}}
	
	% tocloft
	\renewcommand{\cfttoctitlefont}{\Large\headfamily\bfseries\color{DrakeBlue}}
    \renewcommand{\cftloftitlefont}{\Large\headfamily\bfseries\color{DrakeBlue}}
    %\renewcommand{\cftfigfont}{\sfdemifamily}
    \renewcommand{\cftfigfont}{\headfamily\bfseries\color{DrakeBlue}}
    \renewcommand{\cftfigpagefont}{\headfamily\bfseries\color{DrakeBlue}}
	%\renewcommand{\cftchapfont}{\headfamily\bfseries}
	\renewcommand{\cftsecfont}{\headfamily\bfseries\color{DrakeBlue}}
	\renewcommand{\cftsecpagefont}{\headfamily\bfseries\color{DrakeBlue}} 

   \fi
   }


% Hyperlinks
\PassOptionsToPackage{hyphens}{url}
\RequirePackage{hyperref}
%
%\hypersetup{bookmarks=true,pdfborder={0 0 0},colorlinks=true,linkcolor=DrakeBlue,citecolor=DrakeBlue,urlcolor=DrakeBlue,breaklinks=true}
\@ifclassloaded{beamer}
  {\hypersetup{bookmarks=true,pdfborder={0 0 0},colorlinks=true,linkcolor=black,citecolor=black,urlcolor=black,breaklinks=true}}
  {\hypersetup{bookmarks=true,pdfborder={0 0 0},colorlinks=true,linkcolor=DrakeCompRed,citecolor=DrakeCompRed,urlcolor=DrakeCompRed,breaklinks=true}}

%\def\sectionautorefname{Section}
\def\chapterautorefname{Chapter}
\def\sectionautorefname{Section}
\def\subsectionautorefname{\sectionautorefname}
\def\subsubsectionautorefname{\sectionautorefname}

\newcommand{\isbnref}[1]{\href{http://www.amazon.com/gp/search/?field-isbn=#1}{ISBN #1}}
\newcommand{\fnhref}[2]{\href{#1}{#2}\footnote{\url{#1}}}

% Citations
\RequirePackage[numbers,comma,super,sort&compress]{natbib}
\RequirePackage{natmove}
\DeclareRobustCommand\onlinecite{\@onlinecite}
\def\@onlinecite#1{\begingroup\let\@cite\NAT@citenum\citealp{#1}\endgroup}
\newcommand{\doilink}[1]{\href{http://dx.doi.org/#1}{doi:#1}}

% Captions
\RequirePackage[labelfont={bf},font=small]{caption}

% Formatting
\newcommand{\acro}[1]{\textsc{\expandafter\MakeLowercase\expandafter{#1}}}
\newcommand{\strong}[1]{\textbf{#1}}
\newcommand{\stronghead}[1]{\textbf{\headfamily #1}}
\newcommand{\thead}[1]{\stronghead{#1}}
\newcommand{\filename}[1]{\nolinkurl{#1}}

% List formatting
\@ifclassloaded{beamer}
  {\relax}
  {%\RequirePackage{enumitem}
   %\newcommand{\enumitem}[1]{\stronghead{#1}}
   %\setlist[enumerate]{label=\enumitem{\arabic*.}}
	\renewcommand{\labelenumi}{\stronghead{\arabic{enumi}.}}
	\renewcommand{\labelenumii}{\stronghead{(\alph{enumii})}}
   \renewcommand{\labelitemii}{\rule[0.5ex]{0.55ex}{0.55ex}}
  }
\renewcommand{\arraystretch}{1.2}

% Math formatting
\newtagform{stronghead}[\stronghead]{\stronghead{(}}{\stronghead{)}}\usetagform{stronghead}

\newcommand{\about}{\ensuremath{\sim}}
\renewcommand{\d}{d\!}
\newcommand{\subword}[1]{_{\text{\normalfont #1}}}
\newcommand{\supword}[1]{^{\text{\normalfont #1}}}
\renewcommand{\ij}{{i\mkern-5mu j}}
\newcommand{\ii}{{i\mkern-3mu i}}
\newcommand{\ji}{{j\mkern-3mu i}}
\let\@oldvec\vec
\ifmczchem@usefonts
	\renewcommand{\vec}[1]{\mkern2mu\overrightarrow{\mkern-2mu#1}}
\fi
\newcommand{\mat}[1]{\mathbfup{#1}}
\newcommand{\Real}{\mathbb{R}}
\newcommand{\Complex}{\mathbb{C}}

\newcommand{\ket}[1]{\ensuremath{\left| #1 \right>}}
\newcommand{\bra}[1]{\ensuremath{\left< #1 \right|}}
\newcommand{\braket}[2]{\ensuremath{\left< #1 \left| \right. #2 \right>}}
\WithSuffix\newcommand\braket*[3]{\ensuremath{\left< #1 \left| \mkern3mu #2 \mkern3mu \right| #3 \right>}}
\newcommand{\operator}[1]{\ensuremath{\widehat{#1}}}


%  unit vectors
\newcommand{\xunit}{\ensuremath{\mkern2mu \vec{\textbf{ı}} \mkern2mu}}
\newcommand{\yunit}{\ensuremath{\mkern2mu \vec{\textbf{ȷ}} \mkern2mu}}
\newcommand{\zunit}{\ensuremath{\mkern2mu \vec{\textbf{k}} \mkern2mu}}
\DeclareMathOperator{\erfc}{erfc}


% Nicer than \begin.\end.
\newcommand{\avg}[1]{\ensuremath{\left<#1\right>}}
\newcommand{\parens}[1]{\ensuremath{\left(#1\right)}}
\newcommand{\sqbrackets}[1]{\ensuremath{\left[#1\right]}}
\newcommand{\magn}[1]{\ensuremath{\left|#1\right|}}

% Scientific nomenclature and formatting
\newcommand{\degrees}{\ensuremath{^\circ}}
\newcommand{\kB}{\ensuremath{k_\mathrm{B}}}

% dirty trick for SN1, SN2: looks like \SN1, \SN2, but is really
% \SN{1}, \SN{2}
\newcommand{\SN}[1]{\ensuremath{\text{S}_\text{N}#1}}

%\newcommand{\Gas}{\ce{{(g)}}}
%\newcommand{\Aq}{\ce{{(aq)}}}
%\newcommand{\Liquid}{\ce{{(\ell)}}}
%\newcommand{\Solid}{\ce{{(s)}}}
\newcommand{\cephase}[1]{\text{{\emph{(#1)}}}}
\newcommand{\Gas}{\cephase{g}}
\newcommand{\Liquid}{\cephase{ℓ}}
\newcommand{\Solid}{\cephase{s}}
\newcommand{\Aq}{\cephase{aq}}
\newcommand{\Std}{\ensuremath{^\circ}}
\newcommand{\rxn}{\subword{rxn}}
\newcommand{\conc}[1]{\ensuremath{\sqbrackets{\ce{#1}}}}

\newcommand{\FaradayConst}{\ensuremath{\mathcal{F}}}
\newcommand{\Ecell}{\ensuremath{E_{\mathrm{cell}}}}
\newcommand{\Voltage}{\ensuremath{\mathcal{V}}}

%  pH, pOH, pKa, pKb, etc
\newcommand{\p}{\ensuremath{\text{p}}}
\newcommand{\Kw}{\ensuremath{K_\mathrm{w}}}
\newcommand{\pKw}{\ensuremath{\p \Kw}}
\newcommand{\pH}{\ensuremath{\text{pH}}}
\newcommand{\pOH}{\ensuremath{\text{pOH}}}

\newcommand\Ka[1][]{%
  \ifstrempty{#1}{%
    \ensuremath{K_\mathrm{a}}%
  }{%
    \ensuremath{K_{\mathrm{a}_{#1}}}%
  }%
}

\newcommand\pKa[1][]{%
  \ifstrempty{#1}{%
    \ensuremath{\mathrm{p}K_\mathrm{a}}%
  }{%
    \ensuremath{\mathrm{p}K_{\mathrm{a}_{#1}}}%
  }%
}

\newcommand\Kb[1][]{%
  \ifstrempty{#1}{%
    \ensuremath{K_\mathrm{b}}%
  }{%
    \ensuremath{K_{\mathrm{b}_{#1}}}%
  }%
}

\newcommand\pKb[1][]{%
  \ifstrempty{#1}{%
    \ensuremath{\mathrm{p}K_\mathrm{b}}%
  }{%
    \ensuremath{\mathrm{p}K_{\mathrm{b}_{#1}}}%
  }%
}

% Programming
\newcommand{\codelit}[1]{\texttt{\detokenize{#1}}}

% Units
% \unit(*) changes with text font and does not support math in its 
% argument
\newcommand\unit[1]{\ensuremath{\;\text{#1}}}
\WithSuffix\newcommand\unit*[1]{\ensuremath{\text{#1}}}
% \munit(*) uses mathrm and does support math in its argument
\newcommand\munit[1]{\ensuremath{\;\mathrm{#1}}}
\WithSuffix\newcommand\munit*[1]{\ensuremath{\mathrm{#1}}}
\newcommand{\degC}{\unit{°C}}
\WithSuffix\newcommand\degC*{\unit*{°C}}
%\newcommand{\Angstrom}{\mbox{\AA}}
\newcommand{\Angstrom}{Å}
\newcommand{\microsecond}{\unit{\mu s}}
\newcommand{\molal}{\ \mbox{\textit{m}}}
\newcommand{\LAtmMolK}{\ensuremath{\unit{L}\cdot\unit*{atm}\cdot\unit*{mol}^{-1}\cdot\unit*{K}^{-1}}}
\newcommand{\LTorrMolK}{\ensuremath{\unit{L}\cdot\unit*{Torr}\cdot\unit*{mol}^{-1}\cdot\unit*{K}^{-1}}}
\newcommand{\MolPerLAtm}{\ensuremath{\unit{mol}\cdot\unit*{L}^{-1}\cdot\unit*{atm}^{-1}}}
\newcommand{\LBarMolK}{\ensuremath{\unit{L}\cdot\unit*{bar}\cdot\unit*{mol}^{-1}\cdot\unit*{K}^{-1}}}

% Question formatting
\@ifclassloaded{exam}%
{\relax}%
{%
\newcounter{question}%[section]
\newcommand{\@questionword}{Question}
\newcommand{\questionlabel}{\stronghead{{\@questionword} \thequestion}}
\newcommand{\pointlabel}[1]{\stronghead{(#1 points)}}
%\newcommand{\question}{\refstepcounter{question}\par\vspace{1.5ex}\noindent\questionlabel.\par\noindent}
%\newcommand\question[1][]{%
%  \refstepcounter{question}\par\vspace{1.5ex}\noindent\questionlabel.%
%  \ifstrempty{#1}{}{\hfill\pointlabel{#1}}%
%  \par\noindent%
%}
%\leavevmode\unskip foo\ignorespaces
\DeclareDocumentCommand{\question}{ O{} }{%
	\refstepcounter{question}%
	\par\vspace{1.5ex}\noindent\questionlabel.%
	\ifstrempty{#1}%
    	{}%
    	{\hfill\pointlabel{#1}}%	
	\nopagebreak\par\noindent\ignorespaces%
}

%\newcommand{\questionsecnum}{\renewcommand{\thequestion}{\thesection.\arabic{question}}}
%\newcommand{\questionplainnum}{\renewcommand{\thequestion}{\arabic{question}}}
\newcommand{\questionsecnum}{\counterwithin{question}{section}}
\newcommand{\questionplainnum}{\counterwithout{question}{section}}

\questionplainnum

\newcommand{\questionword}[1]{\renewcommand{\@questionword}{#1}}
}
\providecommand*{\questionautorefname}{Question}

% Extensions to the exam class (exams, quizzes, printed surveys, etc)
\@ifclassloaded{exam}
  {\newenvironment{mccheckboxes}[1]{\begin{checkboxes}\begin{multicols}{#1}}{\end{multicols}\end{checkboxes}}}
  {\relax}

% Presentation set up

\@ifclassloaded{beamer}{
\renewcommand{\sectionname}{Part}
\setbeamertemplate{itemize item}{\scriptsize\raise1.25pt\hbox{\donotcoloroutermaths$\bullet$}}
\setbeamertemplate{itemize subitem}{\rule[0.5ex]{0.55ex}{0.55ex}}
\setbeamertemplate{itemize subsubitem}{\tiny\raise1.5pt\hbox{\donotcoloroutermaths$\bullet$}}
\setbeamertemplate{caption}{\centering\insertcaption\par}

% These should probably migrate into a theme at some point
%\setbeamerfont{frametitle}{family=\sfmediumfamily}
%\setbeamerfont{title}{family=\sfmediumfamily}
\setbeamerfont{frametitle}{family=\sfdemifamily}
\setbeamerfont{title}{family=\sfdemifamily}
\setbeamerfont{subtitle}{family=\sfmediumfamily}
%\setbeamerfont{description label}{family=\sfmediumfamily}
%\renewcommand{\descriptionlabel}[1]{\hspace{\labelsep}\stronghead{#1}}
\setbeamerfont{description item}{family=\sfmediumfamily}

%\setbeamerfont{quote}{series=\bfseries}
%\setbeamerfont{block title}{series=\bfseries}
\setbeamerfont{quote}{family=\sfdemifamily}
\setbeamerfont{block title}{family=\sfdemifamily}
\newcommand{\cqleader}{—\ }
\newcommand{\citequote}[1]{\begin{flushright}\usebeamerfont*{block body}\small\cqleader #1\end{flushright}}

\newcommand{\blankslide}{\only<beamer>{\begin{frame}\end{frame}}}

\newcommand{\sectionnote}[1]{%
    \begin{tikzpicture}[remember picture,overlay]
        \node[yshift=-1.5ex,xshift=-1ex,anchor=north east] at (current page.north east) {\usebeamerfont{frame subtitle}\emph{#1}};
    \end{tikzpicture}
}

% Raise body?
%\addtobeamertemplate{block begin}{\vspace{-25pt}}{}
\urlstyle{sf}

\newcommand{\footlineextra}[1]{
    \begin{tikzpicture}[remember picture,overlay]
        \node[yshift=1ex,anchor=south west] at (current page.south west) {\usebeamerfont{author in head/foot}\hspace{2ex}#1};
    \end{tikzpicture}
}

% Citation notes: plain, left-justified, centered, right-justified
\newcommand{\citenote}[1]{\itshape\scriptsize#1}
\newcommand{\citenotel}[1]{\raggedright\citenote{#1}}
\newcommand{\citenotec}[1]{\centering\citenote{#1}}
\newcommand{\citenoter}[1]{\raggedleft\citenote{#1}}

\newcommand{\slidenote}[1]{\footlineextra{#1}}
\newcommand{\slidecite}[1]{\footlineextra{\citenote{#1}}}

\mode<presentation>{\usetheme{default}\usecolortheme{dove}\usefonttheme{professionalfonts}}
}{
	\newcommand{\cqleader}{—\ }
	\newcommand{\citequote}[1]{\begin{flushright}\small\cqleader #1\end{flushright}}
}

% Gen chem beamer stuff, possibly useful elsewhere
\newcommand{\TroCitation}{From Tro, \emph{Chemistry: Structure and Properties}}
\newcommand{\DefaultIncludeGraphics}[1]{\includegraphics[width=\linewidth,height=0.8\textheight,keepaspectratio]{#1}}

% Tests, quizzes, etc
\newcommand\instnote[1]{\emph{(#1)}}
\newcommand{\allabove}{\instnote{All of the above.}}
\newcommand{\notabove}{\instnote{None of the above.}}
\newcommand{\underblank}{\underline{\hspace{6em}}}

